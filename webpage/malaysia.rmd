---
pagetitle: SEAsia
output: 
  html_document:
    toc: true
    toc_float: true
    toc_collapsed: true
    toc_depth: 3
    number_sections: true
    theme: cosmo
    #inverse: true
---

``` {r setup, echo = FALSE, message = FALSE, warning = FALSE}
library(pander)
library(dplyr)
library(ggplot2)
library(data.table)
library(tidyr)
theme_set(theme_light())
```

<!-- Allow href to tabsets --> 

```{js, echo = FALSE}
window.onload = function() {
  document.querySelector('a[href="' + window.location.href.match("#.*$") + '"]').click();
}

function goToTab() {
  var hash = String(window.location.href.match("#.*$"));
  var target = document.querySelector("a[role = 'tab'][href='" + hash + "']");
  if (target !== null) {
    var greatgrandparent = target.parentElement.parentElement.parentElement;
    if (greatgrandparent.getAttribute("role") == "tabpanel") {
      document.querySelector("a[role = 'tab'][href='#" + greatgrandparent.getAttribute("id") + "']").click();
    }
    target.click();
    target.scrollIntoView();
  }
}
window.onload = function() {
  setTimeout(goToTab, 100);
}
window.onhashchange = goToTab;
```

<!-- Set table styles -->

<style>
table {
  font-family: arial, sans-serif;
  border-collapse: collapse;
  width: 100%;
}

td, th {
  border: 1px solid #dddddd;
  text-align: left;
  padding: 8px;
}
</style>

<div class="header_logo">
<img src="images/logo_us_state_department.png" style="float:right;height:40px;">
<img src="images/logo_pnnl_white.png" style="float:right;height:40px;">
<img src="images/DoNotCite.png" style="float:right;height:32px;margin-top:8px;margin-right:380px">
</div>

<!-------------------------->
<!-------------------------->
# Executive Summary
<!-------------------------->
<!-------------------------->
<p align="center"> <img src="images/divider.png"></p>

* **Motivation:** Growth across the Association of Southeast Asian Nations (ASEAN) in the past few decades has been driven by urban centers. Rapid urbanization can bring about negative societal impacts, although technological and digital solutions can be used to resolve these issues and enhance quality and accessibility of services. Smart city development projects, including carbon neutrality plans, are one such example. Furthermore, the region is at a high risk for climate hazards, and moving towards carbon neutrality allows for increased mitigation and adaptation efforts to combat these risks.  

* **Objectives:** The Pacific Northwest National Laboratory (PNNL) will collaborate with stakeholders in Kuala Lumpur on implementing low-carbon strategies to achieve carbon neutrality by 2050 and will support smart city development through capacity building. Using the Global Change Analysis Model (GCAM), PNNL will analyze possible policy pathways and trajectories for Kuala Lumpur by applying quantitative modeling techniques.  

* **Approach:** The integrated assessment model GCAM is a modeling tool that represents the behavior of and interactions between five systems: energy, water, agriculture and land use, the climate, and the economy. GCAM will be used to analyze Kuala Lumpur’s existing carbon neutrality plans in a comprehensive manner by modeling inter-sectoral dynamics across several driving sectors, namely energy, buildings, transportation, and industry. PNNL will model different policy scenarios encompassing various socioeconomic, technical, and political factors to better understand the pathways to carbon neutrality in Kuala Lumpur.  

* **Expected Outcomes:** GCAM outputs will be used to guide a report detailing pathways and trajectories for Kuala Lumpur Carbon Neutrality by 2050 that will supplement existing city policies and plans. The report will include potential economic, environmental, and societal impacts of Kuala Lumpur’s carbon neutrality pathway, including abatement/investments costs and possible financing prospects, energy transitions, and air quality and health outcomes. Additionally, PNNL will lead workshops to train local experts on using GCAM and independently conducting analyses, who will then be able to continue further analysis of Kuala Lumpur’s pathways beyond 2050.  

<br>

<!-------------------------->
<!-------------------------->
# Introduction & Motivation
<!-------------------------->
<!-------------------------->
<p align="center"> <img src="images/divider.png"></p>

Southeast Asia as a whole is experiencing a period of rapid growth and urbanization, which can present challenges for decarbonization efforts. The region also faces a heightened risk for climate impacts; in particular, Kuala Lumpur is vulnerable to the effects of high heat as well as increased flooding and droughts. Kuala Lumpur’s vision for approaching these issues is to transform the city into one that is sustainable and livable through its primary climate policies and plans: the Kuala Lumpur Low Carbon Society Blueprint 2030 (KLLCSBP2030), the draft Kuala Lumpur Structure Plan 2040 (KLSP2040), and the Kuala Lumpur Climate Action Plan 2050 (KLCAP2050). The most recent plan was developed to address and fulfill a carbon neutral target by 2050, increase resilience to climate hazards by 2050, incorporate a more inclusive approach to climate planning, and establish a governance structure that will collaborate with all stakeholders to reach climate action goals. Kuala Lumpur developed two scenarios under this plan, a Council-Led scenario aligned with targets from the KLLCSBP2030 and an Integrated Approach scenario highlighting the importance of collaboration across Kuala Lumpur, the Federal government, and other agencies in reaching emissions targets.  

The US-ASEAN Smart Cities Partnership (USASCP) uses innovative approaches across sectors to address the challenges and opportunities of energy development and urbanization in ASEAN Member States. In support of the USASCP, the U.S. Department of State, Bureau of Energy Resources’ (ENR’s) Power Sector Program (PSP) is partnering with Kuala Lumpur to support existing plans to achieve carbon neutrality. The U.S. Department of Energy’s (DOE’s) Pacific Northwest National Laboratory (PNNL) will implement the program by collaborating with local partners, including the Kuala Lumpur City Hall (DBKL or KLCH) and the Universiti Teknologi Malaysia (UTM). PNNL will use its Global Change Analysis Model (GCAM) to model various policy trajectories towards net zero by 2050 and corresponding economic, environmental, and social impacts.


<br>

<!-------------------------->
<!-------------------------->
# Objectives
<!-------------------------->
<!-------------------------->
<p align="center"> <img src="images/divider.png"></p>

Prior to COP26, Malaysia announced that it had set a goal to become carbon neutral _as early as_ 2050. Soon after, Kuala Lumpur committed to becoming a carbon neutral city _by_ 2050. Carbon neutrality refers to a state of "net zero" emissions, where carbon emissions are reduced as far as is feasibly possible, with the remaining emissions offset in some manner.  

As a large city and Malaysia's capital, Kuala Lumpur has an important role in the decarbonization of Malaysia. Kuala Lumpur has outlined several climate-focused plans in the past:

* KLCH Carbon Management Plan 2017-2022: Created to reduce absolute carbon emissions by 20% from Kuala Lumpur City Hall owned, managed, and operated assets.
* KL Low Carbon Society Blueprint 2030: Developed with UTM, this plan aims at reducing 70% of carbon emissions per unit GDP by 2030. 
* KL Draft Structure Plan 2040: Focused on the direction of urban development, with targets for mitigation and adaptation measures.
* KL Climate Action Plan 2050: Targeted on achieving carbon neutrality, addressing climate change, and inclusive planning through strong governance and collaboration.

PNNL and UTM will continue to support Kuala Lumpur on its journey to carbon neutrality. Using the modeling approach outlined below, PNNL will provide an analysis of scenarios developed in the KLCAP2050, encompassing targets outlined in previous plans and policies. PNNL will also provide a national level analysis, looking at Malaysia-level policies. These include:

* National Transport Policy
* National Renewable Energy Policy and Plan
* Malaysia Renewable Energy Roadmap
* National Energy Efficiency Action Plan
* National Policy on Climate Change
* Green Technology Master Plan Malaysia

<br>

<!-------------------------->
<!-------------------------->
# Approach
<!-------------------------->
<!-------------------------->
<p align="center"> <img src="images/divider.png"></p>

Integrated Assessment Models (IAMs) are computational models that use links and feedbacks between socioeconomic and environmental systems to assess the implications of technology and policy choices in the context of global climate change. IAMs can provide a holistic approach to energy sector planning by considering multi-sector dynamics and global processes. GCAM, an IAM developed at PNNL, incorporates socioeconomics, energy, land use, water, and climate system (Figure 1). The model is global but can also be used to assess specific regions and fine scale processes; PNNL has developed both Malaysia and Kuala Lumpur regions within the model for national and city level analyses. GCAM utilizes the most up to date data on population, GDP, technology characteristics, policies, resource availability, and other inputs. It has the detailed representation of energy technologies in different sectors, including electricity, buildings, transportation, industry, hydrogen production, and other energy supply sectors. The model produces both historical and projected future outputs based on this information. These outputs include greenhouse gas emissions, electricity prices, energy supply and demand, and other indicators at five-year time steps from a historical baseline year to the desired end year. PNNL will use GCAM to assess the implications of Kuala Lumpur's various climate-focused plans.

```{r gcam-diagram, echo = FALSE, out.width = "70%", fig.align = 'center', fig.cap = "**Figure 1: Conceptual diagram of GCAM.**"}
knitr::include_graphics("images/GCAM_diagram.png")
```


<br>


<!-------------------------->
<!-------------------------->
# Scenarios {.tabset}
<!-------------------------->
<!-------------------------->
<p align="center"> <img src="images/divider.png"></p>

PNNL, with input from KLCH, will develop a set of GCAM scenarios based on the KLCAP2050 and other relevant policies and plans. These scenarios will outline possible outcomes of various policies. Key indicators may include greenhouse gas emissions, energy demand, and final energy consumption; for more details, please reference 7.1 below.

* **BAU:** Baseline scenario based on existing policies only, with no additional actions. This will serve as a comparison for the remaining scenarios to assess the magnitude of outcomes.
* **Council-Led:** Scenario driven by strategies and actions that are ambitious and achievable within the authority of KLCH, including the implementation of all National policies.
* **Integrated Approach:** Scenario relying on an integrated approach with KLCH, the Federal government, and other agencies, highlighting the potential emissions reductions that could occur should all parties align.
* **Carbon Neutral Malaysia and Kuala Lumpur:** Scenario using the most efficient pathway to net zero CO~2~ emissions by 2050 at the national and city levels.

<br>

<!-------------------------->
## Council-Led
<!-------------------------->

**Council-Led Scenario:** In this scenario, KLCH has the authority to implement measures to achieve carbon emissions reductions. The scenario will largely be achieved through existing actions outlined in the KLLCSBP2030, Federal policies and plans, and publicly declared renewable energy targets. 

Note that this scenario _does not_ meet Kuala Lumpur's benchmark targets for 2030 or 2050; this is due to the lack of power and capacity for KLCH to implement more ambitious actions. Key remaining emissions will come from the following sectors: residential, commercial and institutional buildings, industrial energy, and on-road transportation.

The table below summarizes some of the policies encompassed by the Council-Led scenario. For additional policies, please reference the <a href = "malaysia_appendix.html"> Appendix </a>.
<br>

```{r council-led, results = 'show', echo = FALSE, warning = FALSE, error = FALSE, message = FALSE}
myTable = data.frame(
    Sector     = c("Energy supply",
                   "Transportation",
                   "Buildings"),
    Policies = c("Electricity tariff",
                 "Introduce electric vehicles",
                 "* Install solar PV systems\
                 \n * Institute energy efficiency standards and requirements in buildings\
                 \n * Decrease energy consumption\
                 \n * Increase use of renewable energy"),
    Source = c("KLLCSBP2030")
    ) 
pander::pander(myTable, keep.line.breaks = TRUE, style = "grid", justify = 'left', split.tables=Inf, caption = "")
```

<br>

<!-------------------------->
<!-------------------------->
## Integrated Approach
<!-------------------------->
<!-------------------------->

**Integrated Approach Scenario:** This scenario explores the potential carbon emissions reductions that could occur with strong collaboration between different stakeholders. Kuala Lumpur could be an advocate for such solutions, but the measures outlined in this scenario involve policy shifts at the Federal level.

Even if all scenario targets are met, Kuala Lumpur would still have residual emissions in situations where no mitigation technology exists or where a low-emissions alternative is technically or economically non-viable in the near-term. Top sources include solid waste, commercial and institutional buildings, and on-road transportation.

```{r integrated-approach, results = 'show', echo = FALSE, warning = FALSE, error = FALSE, message = FALSE}
myTable = data.frame(
    Sector     = c(),
    Policies = c()
    ) 
#pander::pander(myTable, keep.line.breaks = TRUE, style = "grid", justify = 'left', split.tables=Inf, caption = "")

```

<br>

<!-------------------------->
<!-------------------------->
## Carbon Neutral Malaysia and Kuala Lumpur
<!-------------------------->
<!-------------------------->

**Carbon Neutral Malaysia and Kuala Lumpur:** Prior to COP26, Malaysia pledged to achieve carbon neutrality as early as 2050. Later in 2021, Kuala Lumpur committed to becoming a carbon-neutral city by 2050. The Carbon Neutral Malaysia and Kuala Lumpur scenario represents the most economically efficient pathway to reach carbon neutrality by 2050 given the policies outlined in the scenarios described above. This pathway will be found using GCAM’s solving capabilities. The outcomes of this scenario will provide insight into the role that that KLCH can play in achieving carbon neutrality and additional measures that may need to be taken.

<br>

<!-------------------------->
<!-------------------------->
# Scope {.tabset}
<!-------------------------->
<!-------------------------->
<p align="center"> <img src="images/divider.png"></p>

<!-------------------------->
<!-------------------------->
## Spatial
<!-------------------------->
<!-------------------------->

```{r KL-map, echo = FALSE, out.width = "70%", out.extra='style="float:right; padding:10px"'}
knitr::include_graphics("./images/MY_KL_map.png")
```

PNNL will assess outcomes at both the national and city level. The Council-Led scenario encompasses only policies that can be implemented by KLCH, although the Integrated Approach scenario requires additional action at the national level. Therefore, PNNL will perform some country level analysis, with the primary focus remaining on Kuala Lumpur. 

The map to the right shows Kuala Lumpur's location within Malaysia.

<br>
<br>

<!-------------------------->
<!-------------------------->
## Temporal
<!-------------------------->
<!-------------------------->

Scenarios will be assessed up from the year 2015 to the year 2100, with the GCAM analysis conducted at five-year intervals within this range.

<br>

<!-------------------------->
<!-------------------------->
# Expected Outcomes {.tabset}
<!-------------------------->
<!-------------------------->
<p align="center"> <img src="images/divider.png"></p>

The GCAM model will be used to assist in planning and scenario development as outlined above. Some of the benefits of using GCAM and the integrated modeling approach in general include the following:

* **Climate change context:** With its water and climate systems, GCAM can provide a nuanced analysis of Kuala Lumpur and Malaysia's policies in the context of climate change. GCAM considers the symbiotic relationship between the climate and other systems, allowing for a more comprehensive review of future policy implications.
* **Long-term assessment:** With the ability to model pathways out to the year 2100, GCAM can offer long-term projections of Kuala Lumpur's policies and plans. 
* **Technology analysis:** Using GCAM’s technology scenario capabilities, PNNL will be able to assess the impacts of specific technology implementations on electricity demand, generation, emissions, and prices.
* **Holistic approach:** GCAM's holistic approach will provide insight into how Kuala Lumpur's policies and plans align with broader goals for socioeconomic development and mitigating environmental impacts. Other key socioeconomic indicators gleaned from model results include employment data, further contributing to GCAM's comprehensive projections.

<br>

<!-------------------------->
<!-------------------------->
## Key Indicators
<!-------------------------->
<!-------------------------->

The GCAM output for each scenario will include the following indicators calculated at 5-year timesteps through the year 2050 in the study region, as specified in the Spatial and Temporal Scope section. 
<br>

```{r key-indicators, results = 'show', echo = FALSE, warning = FALSE, error = FALSE, message = FALSE}
myTable = data.frame(
    Indicator = c("Electricity generation", 
                  "Installed power capacity",
                  "Energy demand",
                  "Final energy consumption",
                  "CO2 emissions",
                  "Electricity price",
                  "Transport service output"),
    Description = c("Amount of electricity generated (total & by generation technology",
                    "Power capacity of power plants (total & by generation technology",
                    "Amount of energy demanded (total & by sector",
                    "Amount of energy consumed (total & by sector",
                    "Amount of CO2 emitted (total & by sector",
                    "Price of electricity for consumer by sector",
                    "Output of each type of transportation"),
    Units = c("terawatt-hours (TWh)",
              "TWh",
              "Exajoules (EJ)",
              "EJ",
              "metric tons CO2 equivalent (MT CO2)",
              "US dollars ($USD)",
              "passenger-kilometers (pass-km)")
    ) 
pander::pander(myTable, keep.line.breaks = TRUE, style = "grid", justify = 'left', split.tables=Inf, caption = "Table 7.1.1. Key indicators reported for each scenario.")

```

<br>

<!-------------------------->
<!-------------------------->
## Model Results
<!-------------------------->
<!-------------------------->

PNNL will present GCAM results showing relevant outcomes of the modeled scenarios up to the year 2100. These results could include greenhouse gas emissions, energy supply and demand, electricity prices, and employment impacts, among other indicators. PNNL will work with UTM to determine which indicators are the most important to consider when assessing the impact of city policies.

<br>

<!-------------------------->
<!-------------------------->
## Analysis and Recommendations
<!-------------------------->
<!-------------------------->

PNNL, in collaboration with UTM, will summarize and interpret the GCAM results for each policy pathway and impact indicator. Based on the GCAM results, PNNL and UTM will provide recommendations for policy pathways that best support Kuala Lumpur's development goals while meeting desired targets outlined in city policies and plans. Engagement with and feedback from stakeholders in Kuala Lumpur will be crucial in guiding the discussions to better focus in on Kuala Lumpur's needs. The final results will be summarized in both a report and a peer-reviewed paper.

<br>

<!-------------------------->
<!-------------------------->
# Timeline
<!-------------------------->
<!-------------------------->
<p align="center"> <img src="images/divider.png"></p>

Below is the proposed timeline for GCAM analysis, reports, and stakeholder engagement. 

```{r timeline, echo = FALSE, out.width = "100%", fig.align = 'center', fig.cap = "**Figure 3: Proposed timeline.**"}
knitr::include_graphics("images/KL_timeline.png")
```

<br>

<!-------------------------->
<!-------------------------->
# Inputs {.tabset}
<!-------------------------->
<!-------------------------->
<p align="center"> <img src="images/divider.png"></p>

<!-------------------------->
## Socioeconomics  {.tabset .tabset-pills}
<!-------------------------->
This section details the socioeconomic inputs used to define Malaysia and its subregions, Kuala Lumpur and "Rest of Malaysia," in GCAM. These metrics include population, GDP, and GDP per capita. Historical and projection data were used when available, otherwise data was calculated using the assumptions described below.

<table>

<tr>
<th>Variable</th>
<th style="width:50%">Assumptions</th>
<th style="width:40%">Data Sources</th>
</tr>

<tr>
<td>Population</td>
<td>
<span>- Malaysia population used the medium variant projection and historical data from the UN</span><br/>
<span>- KL census data gives a value for 2010. All other values were extrapolated and calculated using the growth rates for Malaysia in total</span><br/>
<span>- "Rest of Malaysia" values found by subtracting KL numbers from Malaysia</span><br/>
</td>
<td>
<span>- Malaysia: [United Nations](https://population.un.org/wpp/)</span><br/>
<span>- Kuala Lumpur 2010: [United Nations](http://data.un.org/Data.aspx?q=kuala+lumpur&d=POP&f=tableCode%3a240%3bareaCode%3a0%3bsexCode%3a0%3bvarCode3%3a028690%3bvarCode4%3a000002)</span><br/>
</td>
</tr>


<tr>
<td rowspan="3">GDP</td>
<td>
<span>- Malaysia annual growth rates are applied to KL's 2020 GDP value to extrapolate historical and future values</span><br/>
<span>- "Rest of Malaysia" values found by subtracting KL numbers from Malaysia</span>
</td>
<td rowspan="2"> 
<span>- Malaysia, historical: [USDA ERS](https://www.ers.usda.gov/data-products/international-macroeconomic-data-set/)</span><br/>
<span>- Malaysia, future: [SSP database](https://tntcat.iiasa.ac.at/SspDb/dsd?Action=htmlpage&page=welcome)</span><br/>
<span>- Kuala Lumpur 2020: [Department of Statistics Malaysia](https://www.dosm.gov.my/v1/index.php?r=column/cthemeByCat&cat=102&bul_id=anVobldYUFZLNE5WVlRVRExkSWEyZz09&menu_id=TE5CRUZCblh4ZTZMODZIbmk2aWRRQT09)</span><br/>
</td>
</tr>

</table>

<br>
<br>

### Population

#### Historical Trends and Future Projections {-}

To estimate population values, we begin with annual data from the UN for Malaysia's population; we use historical data and a medium population projection scenario. For Kuala Lumpur, we use 2010 census data as our base year. We then calculate annual growth rates using the complete Malaysia dataset and apply these growth rates to extrapolate Kuala Lumpur population values. To find "Rest of Malaysia" values, we subtract Kuala Lumpur population from Malaysia values.

The plot below shows historical and future projected populations in Malaysia and Kuala Lumpur from the GCAM reference scenario from 1975 to 2100.  

``` {r pop-plot, echo = FALSE, fig.dim = c(8,4), fig.cap="Figure 9.1.1.1. **Historical and future projected population in Malaysia and Kuala Lumpur**"}
# Population
pop <- fread("../data/Malaysia/socioeconomic_inputs/gcam_query_pop.csv") %>% as_tibble()

## PLOT
population_plot <- pop %>%
  ggplot(aes(year, value)) +
  geom_line() +
  facet_wrap(~region, scales = "free") +
  scale_color_viridis_d() +
  labs(x = "Year",
       y = "Population (millions)",
       title = "Population in Malaysia and Kuala Lumpur") ; population_plot


```

<br>

### GDP

#### Historical Trends and Future Projections {-}

To find GDP values, we begin with historical data of GDP MER in Malaysia from the U.S. Department of Agriculture's Economic Research Service. We use future projections data from the SSP2 database. In a similar process to the population, we then calculate annual growth rates, which are applied to a base year for Kuala Lumpur. We use the 2020 GDP found in the Kuala Lumpur State Socioeconomic Report 2020. We find "Rest of Malaysia" values by subtracting Kuala Lumpur values from Malaysia.

The following graphs show GDP in billion 2005 USD for Malaysia and Kuala Lumpur.

``` {r gdp, echo = FALSE, fig.dim = c(8,4), fig.cap="Figure 9.1.2.1. **Historical and future projected GDP in Malaysia and Kuala Lumpur**"}
# GDP
gdp <- fread("../data/Malaysia/socioeconomic_inputs/gcam_query_gdp.csv") %>% as_tibble()

## PLOT
gdp_plot <- gdp %>%
  ggplot(aes(year, value)) +
  geom_line() +
  facet_wrap(~region, scales = "free") +
  scale_color_viridis_d() +
  labs(x = "Year",
       y = "Billion (2005 USD)",
       title = "GDP in Malaysia and Kuala Lumpur") ; gdp_plot

```

<br>

### Per capita GDP

#### Historical Trends and Future Projections {-}

To find GDP per capita, we divide the above GDP values by the above population values. 

GDP per capita, in units of thousand 2005 USD, is shown below for Malaysia and Kuala Lumpur. 

``` {r gdp_pc, echo = FALSE, fig.dim = c(8,4), fig.cap="Figure 9.1.3.1. **Historical and future projected GDP per capita in Malaysia and Kuala Lumpur**"}
gdp_pc <- fread("../data/Malaysia/socioeconomic_inputs/gcam_query_pcgdp.csv") %>% as_tibble()

## PLOT
gdp_pc_plot <- gdp_pc %>%
  ggplot(aes(year, value)) +
  geom_line() +
  facet_wrap(~region, scales = "free") +
  scale_color_viridis_d() +
  labs(x = "Year",
       y = "Thousand (2005 USD) per person",
       title = "GDP per capita in Malaysia and Kuala Lumpur") ; gdp_pc_plot


```

<br>

<!-------------------------->
<!-------------------------->
# GCAM Initial Diagnostics {.tabset}
<!-------------------------->
<!-------------------------->
<p align="center"> <img src="images/divider.png"></p>

<!-------------------------->
## Energy {.tabset .tabset-pills}
<!-------------------------->

### Final consumption
``` {r final-energy, echo = FALSE, message = FALSE, fig.dim = c(9,4), fig.cap = "**Figure 10.1.1.1**"}
final_energy <- fread("../data/Malaysia/gcam_diagnostics/gcam_query_energy.csv") %>% as_tibble()

energy <- final_energy %>%
  filter(region != "Malaysia") %>%
  group_by(year, region) %>%
  summarize(Units, scenario, region, value = sum(value)) %>%
  distinct(year, .keep_all = TRUE)

energy_my <-  energy %>%
  group_by(year) %>%
  mutate(value = sum(value)) %>%
  filter(region == "KualaLumpur") %>%
  select(year, scenario, value) %>%
  mutate(region = "Malaysia",
         Units = "MtCO2")

energy_plot_data <- bind_rows(energy, energy_my)

energy_plot <- energy_plot_data %>%
  filter(region != "Rest of Malaysia") %>%
  ggplot(aes(year, value)) +
  geom_line() +
  facet_wrap(~region, scales = "free") +
  labs(x = "Year",
       y = "EJ",
       title = "Final energy consumption in Malaysia and KL",
       subtitle = "Source: GCAM Ref"); energy_plot

```

<!-------------------------->
## Electricity {.tabset .tabset-pills}
<!-------------------------->

### Final consumption
``` {r final-electricity, echo = FALSE, message = FALSE, fig.dim = c(9,4), fig.cap = "**Figure 10.2.1.1**"}
elec <- fread("../data/Malaysia/gcam_diagnostics/gcam_query_electricity.csv")

total_consumption <- elec %>%
  filter(region != "Malaysia") %>%
  group_by(year, region) %>%
  summarize(Units, scenario, region, value = sum(value)) %>%
  distinct(year, .keep_all = TRUE)

consumption_my <- total_consumption %>%
  group_by(year) %>%
  mutate(value = sum(value)) %>%
  filter(region == "KualaLumpur") %>%
  select(year, scenario, value) %>%
  mutate(region = "Malaysia",
         Units = "MtCO2")

elec_plot_data <- bind_rows(total_consumption, consumption_my)

elec_consumption_plot <- elec_plot_data %>%
  filter(region != "Rest of Malaysia") %>%
  ggplot(aes(year, value)) +
  geom_line() +
  facet_wrap(~region, scales = "free") +
  labs(x = "Year",
       y = "EJ",
       title = "Total electricity consumption in Malaysia and KL",
       subtitle = "Source: GCAM Ref"); elec_consumption_plot
```

<!-------------------------->
## Emissions {.tabset .tabset-pills}
<!-------------------------->

### CO2 by Sector
``` {r co2-emissions, echo = FALSE, message = FALSE, fig.dim = c(9,4), fig.cap = "**Figure 10.3.1.1**"}
co2_sector <- fread("../data/Malaysia/gcam_diagnostics/gcam_query_co2_sector.csv")

co2_sector_to_year <- co2_sector %>%
  filter(region != "Malaysia") %>%
  group_by(scenario, year, Units, region) %>%
  summarize(value = sum(value, na.rm = T)) %>%
  # convert from MtC to MtCO2
  mutate(value = value * 3.67,
         Units = "MtCO2") %>%
  rename("units" = "Units") %>%
  filter(region != "Malaysia")

co2_my <- co2_sector_to_year  %>%
  group_by(year) %>%
  mutate(value = sum(value)) %>%
  filter(region == "KualaLumpur") %>%
  select(year, scenario, value) %>%
  mutate(region = "Malaysia",
         Units = "MtCO2")

co2_plot_data <- bind_rows(co2_sector_to_year, co2_my)

# Total emissions in Malaysia and KL over time
co2_plot <- co2_plot_data %>%
  filter(region != "Rest of Malaysia") %>%
  ggplot(aes(year, value)) +
  geom_line() +
  facet_wrap(~region, scales = "free") +
  labs(x = "Year",
       y = "MtCO2",
       title = "Total CO2 emissions over time in Malaysia and KL",
       subtitle = "Source: GCAM Ref") ; co2_plot

```

<!-------------------------->
## Buildings {.tabset .tabset-pills}
<!-------------------------->

### CO2 emissions
``` {r building-co2, echo = FALSE, message = FALSE, fig.dim = c(9,4), fig.cap = "**Figure 10.4.1.1**"}

co2_buildings <- fread("../data/Malaysia/gcam_diagnostics/gcam_query_co2_buildings.csv")
  
co2_buildings_total <- co2_buildings %>%
  filter(region != "Malaysia") %>%
  group_by(year, region) %>%
  summarize(scenario, region, value = sum(value)) %>%
  distinct(year, .keep_all = TRUE) %>%
  mutate(value = value * 3.67,
         units = "MtCO2")

co2_buildings_my <- co2_buildings_total %>%
  group_by(year) %>%
  mutate(my_value = sum(value)) %>%
  filter(region == "KualaLumpur") %>%
  select(year, scenario,
         value = my_value) %>%
  mutate(region = "Malaysia",
         Units = "MtCO2")

co2_buildings_plot_data <- bind_rows(co2_buildings_total, co2_buildings_my)

co2_buildings_plot <- co2_buildings_plot_data %>%
  filter(region != "Rest of Malaysia") %>%
  ggplot(aes(year, value)) +
  geom_line() +
  facet_wrap(~region, scales = "free") +
  labs(x = "Year",
       y = "MtCO2",
       title = "Building CO2 emissions in Malaysia and KL",
       subtitle = "Source: GCAM Ref") ; co2_buildings_plot

```

### Energy consumption
``` {r building-energy, echo = FALSE, message = FALSE, fig.dim = c(9,4), fig.cap = "**Figure 10.4.2.1**"}

building_energy <- fread("../data/Malaysia/gcam_diagnostics/gcam_query_building_energy.csv")

building_final_energy <- building_energy %>%
  group_by(year, region) %>%
  summarize(Units, scenario, region, value = sum(value)) %>%
  distinct(year, .keep_all = TRUE)

building_fe_my <- building_final_energy %>%
  group_by(year) %>%
  mutate(my_value = sum(value)) %>%
  filter(region == "KualaLumpur") %>%
  select(year, scenario,
         value = my_value) %>%
  mutate(region = "Malaysia",
         Units = "MtCO2")

building_fe_plot_data <- bind_rows(building_final_energy, building_fe_my) %>%
  filter(region != "Rest of Malaysia")

building_final_energy_plot <- building_fe_plot_data %>%
  ggplot(aes(year, value)) +
  geom_line() +
  facet_wrap(~region, scales = "free") +
  labs(x = "Year",
       y = "EJ",
       title = "Building final energy consumption in Malaysia and KL",
       subtitle = "Source: GCAM Ref") ; building_final_energy_plot

```

### Energy consumption by sector
``` {r building-energy-sector, echo = FALSE, message = FALSE, fig.dim = c(9,4), fig.cap = "**Figure 10.4.3.1**"}

building_energy_sector <- fread("../data/Malaysia/gcam_diagnostics/gcam_query_building_energy_sector.csv")

be_sector <- building_energy_sector %>%
  group_by(year, region, sector) %>%
  summarize(Units, scenario, region, value = sum(value)) %>%
  distinct(year, .keep_all = TRUE)

be_sector_my <- be_sector %>%
  group_by(year, sector) %>%
  mutate(my_value = sum(value)) %>%
  filter(region == "KualaLumpur") %>%
  select(year, sector, scenario,
         value = my_value) %>%
  mutate(region = "Malaysia",
         Units = "MtCO2")

be_sector_plot_data <- bind_rows(be_sector, be_sector_my) %>%
  filter(region != "Rest of Malaysia")
be_sector_plot_data$sector <- be_sector_plot_data$sector %>% factor(levels = rev(c("comm others", "resid others", "comm cooling", "resid cooling")))

be_sector_plot <- be_sector_plot_data %>%
  ggplot(aes(year, value, fill = sector)) +
  geom_col() +
  scale_fill_manual(breaks = c("resid cooling", "comm cooling", "resid others", "comm others"),
                       labels = c("Residential cooling", "Commerical cooling", "Residential - other", "Commerical - other"),
                       values = c("#6865C1", "#342DFC", "#D4C592", "#BD8A25")) +
  facet_wrap(~region, scales = "free") +
  labs(x = "Year",
       y = "EJ",
       title = "Building final energy consumption by sector in Malaysia and KL",
       subtitle = "Source: GCAM Ref",
       fill = "Sector") ; be_sector_plot

```

<!-------------------------->
## Transportation {.tabset .tabset-pills}
<!-------------------------->

### CO2 emissions
``` {r transport-co2, echo = FALSE, message = FALSE, fig.dim = c(9,4), fig.cap = "**Figure 10.5.1.1**"}

co2_subsector <- fread("../data/Malaysia/gcam_diagnostics/gcam_query_co2_subsector.csv")

trn_emis_subsector <- co2_subsector %>%
  filter(grepl("trn", sector))

total_te <- trn_emis_subsector %>%
  filter(region != "Malaysia") %>%
  group_by(year, region) %>%
  summarize(Units, scenario, region, value = sum(value)) %>%
  distinct(year, .keep_all = TRUE) %>%
  # convert from MtC to MtCO2
  mutate(value = value * 3.67)

te_my <- total_te %>%
  group_by(year) %>%
  mutate(value = sum(value)) %>%
  filter(region == "KualaLumpur") %>%
  select(year, scenario, value) %>%
  mutate(region = "Malaysia",
         Units = "MtCO2")

te_plot_data <- bind_rows(total_te, te_my)

total_te_plot <- te_plot_data %>%
  filter(region != "Rest of Malaysia") %>%
  ggplot(aes(year, value)) +
  geom_line() +
  facet_wrap(~region, scales = "free") +
  labs(x = "Year",
       y = "MtCO2",
       title = "Total transportation emissions in Malaysia and KL",
       subtitle = "Source: GCAM Ref"); total_te_plot

```

### CO2 emissions by mode
``` {r transport-co2-mode, echo = FALSE, message = FALSE, fig.dim = c(9,4), fig.cap = "**Figure 10.5.2.1**"}
tesub_rail <- trn_emis_subsector %>%
  filter(subsector %in% c("Passenger Rail", "Freight Rail")) %>%
  group_by(year, region) %>%
  summarize(Units, scenario, region, rail = sum(value)) %>%
  distinct(year, .keep_all = TRUE) %>%
  pivot_longer(rail, names_to = "sector") %>%
  # convert from MtC to MtCO2
  mutate(value = value * 3.67)

tesub_onroad <- trn_emis_subsector %>%
  filter(subsector %in% c("Heavy truck", "Light truck", "Medium truck", "Large Car and Truck",
                          "2W and 3W", "Mini car", "Car", "Bus")) %>%
  group_by(year, region) %>%
  summarize(Units, scenario, region, road = sum(value)) %>%
  distinct(year, .keep_all = TRUE) %>%
  pivot_longer(road, names_to = "sector") %>%
  # convert from MtC to MtCO2
  mutate(value = value * 3.67)

tesub_ship <- trn_emis_subsector %>%
  filter(subsector %in% c("Domestic Ship", "International Ship")) %>%
  group_by(year, region) %>%
  summarize(Units, scenario, region, ship = sum(value)) %>%
  distinct(year, .keep_all = TRUE) %>%
  pivot_longer(ship, names_to = "sector") %>%
  # convert from MtC to MtCO2
  mutate(value = value * 3.67)

tesub_air <- trn_emis_subsector %>%
  filter(subsector %in% c("International Aviation", "Domestic Aviation")) %>%
  group_by(year, region) %>%
  summarize(Units, scenario, region, air = sum(value)) %>%
  distinct(year, .keep_all = TRUE) %>%
  pivot_longer(air, names_to = "sector") %>%
  # convert from MtC to MtCO2
  mutate(value = value * 3.67)

te_all_sectors <- bind_rows(tesub_onroad, tesub_rail, tesub_air, tesub_ship) %>%
  filter(region != "Malaysia")

te_all_my <- te_all_sectors %>%
  group_by(year, sector) %>%
  mutate(value = sum(value)) %>%
  filter(region == "KualaLumpur") %>%
  select(year, sector, scenario, value) %>%
  mutate(region = "Malaysia",
         Units = "MtCO2")

te_all_plot_data <- bind_rows(te_all_sectors, te_all_my)
te_all_plot_data$sector <- te_all_plot_data$sector %>% factor(levels = rev(c("air", "road", "ship", "rail")))

## PLOT
te_mode_plot <- te_all_plot_data %>%
  filter(region != "Rest of Malaysia") %>%
  ggplot(aes(year, value, fill = sector)) +
  geom_col() +
  facet_wrap(~region, scales = "free") +
  scale_fill_manual(breaks = c("rail", "ship", "road", "air"),
                       labels = c("Rail", "Ship", "Road", "Air"),
                       values = c("#58A989", "#2f4e79", "grey60", "cadetblue3")) +
  labs(x = "Year",
       y = "MtCO2",
       title = "Transportation emissions by mode in Malaysia and KL",
       subtitle = "Source: GCAM Ref",
       fill = "Sector"); te_mode_plot

```

### CO2 emissions by class - road
``` {r transport-co2-class-road, echo = FALSE, message = FALSE, fig.dim = c(9,4), fig.cap = "**Figure 10.5.3.1**"}

tesub_truck <- trn_emis_subsector %>%
  filter(subsector %in% c("Heavy truck", "Light truck", "Medium truck",
                          "Large Car and Truck")) %>%
  group_by(year, region) %>%
  summarize(Units, scenario, region, truck = sum(value)) %>%
  distinct(year, .keep_all = TRUE) %>%
  pivot_longer(truck, names_to = "sector") %>%
  # convert from MtC to MtCO2
  mutate(value = value * 3.67)

tesub_car <- trn_emis_subsector %>%
  filter(subsector %in% c("Car", "Mini car")) %>%
  group_by(year, region) %>%
  summarize(Units, scenario, region, car = sum(value)) %>%
  distinct(year, .keep_all = TRUE) %>%
  pivot_longer(car, names_to = "sector") %>%
  # convert from MtC to MtCO2
  mutate(value = value * 3.67)

tesub_bus <- trn_emis_subsector %>%
  filter(subsector == "Bus") %>%
  mutate(value = value * 3.67) %>%
  select(!sector) %>%
  rename(sector = subsector)

tesub_motorc <- trn_emis_subsector %>%
  filter(subsector == "2W and 3W") %>%
  mutate(value = value * 3.67,
         subsector = "motorcycle") %>%
  select(!sector) %>%
  rename(sector = subsector)

te_class <- bind_rows(tesub_truck, tesub_bus, tesub_car, tesub_motorc) %>%
  mutate(Units = "MtCO2") %>%
  filter(region != "Malaysia")

# Need to manually compute Malaysia values
te_my <- te_class %>%
  group_by(year, sector) %>%
  mutate(my_value = sum(value)) %>%
  filter(region == "KualaLumpur") %>%
  select(year, sector, scenario,
         value = my_value) %>%
  mutate(region = "Malaysia",
         Units = "MtCO2")

te_class_plot_data <- bind_rows(te_class, te_my)
te_class_plot_data$sector <- te_class_plot_data$sector %>% factor(levels = rev(c("truck", "motorcycle", "Bus", "car")))

te_class_plot <- te_class_plot_data %>%
  filter(region != "Rest of Malaysia") %>%
  ggplot(aes(year, value, fill = sector)) +
  geom_col() +
  scale_fill_manual(breaks = c("car", "Bus", "motorcycle", "truck"),
                  labels = c("Car", "Bus", "Motorcycle", "Truck"),
                  values = c("red", "yellowgreen", "#5E85D2", "#792f2f")) +
  facet_wrap(~region, scales = "free") +
  labs(x = "Year",
       y = "MtCO2",
       title = "Transportation CO2 emissions by class in Malaysia and KL",
       subtitle = "Source: GCAM Ref",
       fill = "Sector"); te_class_plot

```

<br>

<!-------------------------->
<!-------------------------->
# Data needs and/or questions
<!-------------------------->
<!-------------------------->
<p align="center"> <img src="images/divider.png"></p>

* Sectoral emissions for each scenario: After review of the KLCAP2050, the team noted some discrepancies in the data presented. A primary data need is emissions for at least the key years (2030, 2050) broken down by sector for each scenario (BAU, Council Led, and Integrated Approach). A detailed breakdown of the discrepancies can be provided upon request. 

<br>

<!-------------------------->
<!-------------------------->
# Appendix
<!-------------------------->
<!-------------------------->
<p align="center"> <img src="images/divider.png"></p>

See <a href = "malaysia_appendix.html"> Appendix </a> for supplementary information.

<br>


<!-- example alternative table style -->
```{r, eval = FALSE, echo = FALSE, warning = FALSE, error = FALSE, message = FALSE}
library(kableExtra)
data.frame(
    Model     = c("WRF",
                  "GCAM",
                  "Xanthos",
                  "Helios",
                  "GGCMI",
                  "rpackageutils",
                  "im3components",
                  "gcamextractor"),
    Version = c("-",
                "gcam v5.3 (branch gcam-usa-im3)",
                "xanthos v2.4.1",
                "helios v1.0.0",
                "ggcmi v1.0.0",
                "rpackageutils v1.0.0",
                "im3components v1.0.0",
                "gcamextractor"),
    Description = c("Climate simulation model",
                    "Global Change Analysis Model. Human-earth systems dynamic model.",
                    "Water runoff emulator at 0.5 degree grids and monthly timesteps.",
                    "Gridded Heating and cooling degree day calculator at multiple spatial and temporal resolution.",
                    "Emulators to model agricultural yield impacts in response to climate",
                    "Utility functions to process, aggregate and reformat data.",
                    "Functions to process data between different IM3 models.",
                    "Model to extract and process data from GCAM output databases."),
    Language = c("-",
                  "C++/R",
                  "Python",
                  "R",
                  "?",
                  "R",
                  "R/Python",
                  "R"),
    Link = c("https://www.mmm.ucar.edu/weather-research-and-forecasting-model",
             "https://stash.pnnl.gov/projects/JGCRI/repos/gcam-core/browse?at=refs%2Fheads%2Fzk%2Ffeature%2Fgcam-usa-im3",
            "https://github.com/JGCRI/xanthos",
            "Helios",
            "GGCMI",
            "https://github.com/JGCRI/rpackageutils",
            "https://github.com/IMMM-SFA/im3components",
            "https://github.com/JGCRI/gcamextractor")
    ) %>% 
  kbl() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))

```
