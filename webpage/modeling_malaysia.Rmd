---
pagetitle: Modeling - Malaysia
output: 
  html_document:
    toc: true
    toc_float: true
    toc_collapsed: true
    toc_depth: 2
    number_sections: true
    theme: cosmo
    #inverse: true
---

```{r setup, echo = FALSE, message = FALSE, warning = FALSE}
knitr::opts_chunk$set(results = "hide", echo = FALSE, out.width = "85%", fig.align = 'center', message = F, warning = F, error = F, eval = T)

library(kableExtra)
library(dplyr)
library(gcamextractor)
library(rchart)
```


```{r child = 'header.rmd'}
```

<!-------------------------->
<!-------------------------->
# Download GCAM SE Asia
<!-------------------------->
<!-------------------------->
<p align="center"> <img src="images/divider.png"></p>

<br>

Please use the link below to download GCAM.

```{r key-links-table, results = 'show', eval = TRUE, echo = FALSE, warning = FALSE, error = FALSE, message = FALSE}

dt_url <- c("https://drive.google.com/file/d/1AFhbaTf6K6UsLsIXpne4_ska3stYIHRa/view?usp=sharing")

data.frame(
  File = c("gcamv5p3_seasia")) %>% 
  dplyr::mutate(Location = cell_spec(rep("Link",length(dt_url)),"html",link=dt_url)) %>%
  kable("html", escape = FALSE) %>%
  kable_styling(bootstrap_options = c("bordered","striped", "hover", "condensed", "responsive")) %>%
  row_spec(0, background = "#2A2A2A", color = "white")
```

<br> 

You will need the following prerequisites in order to run GCAM. You will also need at least 8 GB of RAM.

```{r prereq-table, results = 'show', eval = TRUE, echo = FALSE, warning = FALSE, error = FALSE, message = FALSE}

dt_url <- c("https://www.java.com/en/download/",
            "https://cran.r-project.org/",
            "https://www.rstudio.com/",
            "http://symbolclick.com/xmlmarker_1_1_setup.exe")

links <- c("Install Java 64",
           "Install R",
           "Install RStudio",
           "Install Windows XML Maker")

data.frame(
  Prerequisite = c("Java 64",
           "R",
           "RStudio",
           "Windows XML Maker")) %>%
  dplyr::mutate(Link = cell_spec(links,"html",link=dt_url)) %>%
  kable("html", escape = FALSE) %>%
  kable_styling(bootstrap_options = c("bordered", "striped", "hover", "condensed", "responsive")) %>%
  row_spec(0, background = "#2A2A2A", color = "white")

```

<br>

<!-------------------------->
<!-------------------------->
# Guides
<!-------------------------->
<!-------------------------->
<p align="center"> <img src="images/divider.png"></p>

<br>

Below are links to an overview and walkthrough of GCAM.

```{r presentation-links-table, results = 'show', eval = TRUE, echo = FALSE, warning = FALSE, error = FALSE, message = FALSE}

dt_url <- c("https://github.com/JGCRI/seasia/blob/main/modeling/gcam_overview.pdf",
            "https://github.com/JGCRI/seasia/blob/main/modeling/gcam_walkthrough.pdf")

xml = c("gcam_overview.pdf",
        "gcam_walkthrough.pdf")

data.frame(
  Description = c("GCAM overview presentation",
                  "GCAM walkthrough presentation")) %>%
  dplyr::mutate(File = cell_spec(xml,"html",link=dt_url)) %>%
  kable("html", escape = FALSE) %>%
  kable_styling(bootstrap_options = c("bordered", "striped", "hover", "condensed", "responsive")) %>%
  row_spec(0, background = "#2A2A2A", color = "white")
```


<br>

<!-------------------------->
<!-------------------------->
# Scenarios
<!-------------------------->
<!-------------------------->
<p align="center"> <img src="images/divider.png"></p>

Below are links to the reference and policy scenarios that we will be using. 

```{r scenarios-links-table, results = 'show', eval = TRUE, echo = FALSE, warning = FALSE, error = FALSE, message = FALSE}

dt_url <- c("https://github.com/JGCRI/seasia/blob/main/modeling/configuration_seasia_cities_bau.xml",
            "https://github.com/JGCRI/seasia/blob/main/modeling/malaysia/configuration_seasia_cities_malaysia_policy.xml")

xml = c("configuration_seasia_cities_bau.xml",
           "configuration_seasia_cities_policy.xml")

data.frame(
  Description = c("Business as Usual Scenario",
                  "Example Policy Scenario")) %>%
  dplyr::mutate(File = cell_spec(xml,"html",link=dt_url)) %>%
  kable("html", escape = FALSE) %>%
  kable_styling(bootstrap_options = c("bordered","striped", "hover", "condensed", "responsive")) %>%
  row_spec(0, background = "#2A2A2A", color = "white")
```



<!-------------------------->
<!-------------------------->
# Policies
<!-------------------------->
<!-------------------------->
<p align="center"> <img src="images/divider.png"></p>

Future policies that will be modeled are described in the table below. In general, two policy scenarios will be presented: a "low ambition" and "high ambition" option. 

<p align="center"> <img src="images/malaysia_initial_policy_assumptions.png"></p>

<br>

The following subsections give additional details and explanations for the policies listed above.
(In progress. Will be expanded with examples for each.)

## Electricity Generation Mix - Subsidy
***

```{r electricity-generation-files-table, results = 'show', eval = TRUE, echo = FALSE, warning = FALSE, error = FALSE, message = FALSE}

dt_url <- c("https://github.com/JGCRI/seasia/blob/main/data/malaysia/inputs/malaysia_elec_fuel_mix_2030_pathway.xlsx",
            "https://github.com/JGCRI/seasia/blob/main/modeling/malaysia/malaysia_elec_fuel_mix_2030_KL.xml",
            "https://github.com/JGCRI/seasia/blob/main/modeling/malaysia/malaysia_hydro_constraint_2030_KL.xml")

files <- c("malaysia_elec_fuel_mix_2030_pathway.xlsx",
           "malaysia_elec_fuel_mix_2030_KL.xml",
           "malaysia_hydro_constraint_2030_KL.xml")

data.frame(
  "Relevant Files" = c("Excel spreadsheet showing initial calculations to build this policy",
                   "XML file for GCAM with electricity generation percentages by fuel in 2030",
                   "XML file for GCAM to set exogenous hydropower generation")) %>%
  dplyr::mutate(Link = cell_spec(files,"html",link=dt_url)) %>%
  kable("html", escape = FALSE, col.names = c("Relevant Files", "Link")) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>%
  row_spec(0, background = "#2A2A2A", color = "white")
```


<!-------------------------->
<!----------Goal------------>
<!-------------------------->

<div class="warning" style='background-color:#E1F4F5; border-left: solid #1f1f1f 4px; border-radius: 4px; padding:0.7em;'>
<span>
<h3 style='text-align:center; font-size:24px'>
<b>Goal</b>
</h3>

<p style='margin-left:1em;'>
The goal of this example is to set a minimum value (floor) in GCAM for the amount of electricity generation from each fuel type (coal, natural gas, solar, etc.) corresponding with the planned percentages in the KLLCSBP2030 (below).

<p align="center"> <img src="images/KL_2030_power.png"></p>

</p>
</span>
</div>

<br>


<!-------------------------->
<!--------Approach---------->
<!-------------------------->

<div class="warning" style='background-color:#fffae0; border-left: solid #1f1f1f 4px; border-radius: 4px; padding:0.7em;'>
<span>

<h3 style='text-align:center; font-size:24px'>
<b>Approach</b></h3>

<p style='margin-left:1em;'>
One way to set a generation floor for each fuel type in GCAM is to use a subsidy policy. This will lower the cost of the electricity generation technology until the floor is reached. If there is more demand for electricity than is supplied by the sum of the generation floors, then the remaining demand will be met by a mix of fuels determined by the market.

Hydropower is exogenous in GCAM and has a fixed pathway. The power generation values for this technology are set explicitly using a fixed output add-on XML. 

</p>
</span>
</div>

<br>


<!-------------------------->
<!--------Background-------->
<!-------------------------->

```{r child = 'background_policy-portfolio-standards.rmd'}
```


<!-------------------------->
<!---GCAM Implementation---->
<!-------------------------->

<div class="warning" style='background-color:#F5E5E1; border-left: solid #1f1f1f 4px; border-radius: 4px; padding:0.7em;'>
<span>
<h3 style='text-align:center; font-size:24px'>
<b>GCAM Implementation</b>
</h3>

<p style='margin-left:1em;'>
1. Create a folder in the input directory eg. `./gcam-core/input/addons/malaysia`.
2. Download the example XML file [malaysia_elec_fuel_mix_2030_KL.xml](https://github.com/JGCRI/seasia/blob/main/modeling/malaysia/malaysia_elec_fuel_mix_2030_KL.xml) to the folder. (Click on `Raw` and then `right-click` and select `save-as`.)
3. To make adjustments: within each `policy-portfolio-standard` tag in the XML, adjust the following:
</p>
<ul style='margin-left:4em; text-align:left;'>
  <li>`constraint` for each year in which a floor is desired</li>
  <li>Set `min-price` to a large negative value for years in which an exact constraint, rather than a floor, is desired</li>
</ul>
<p style='margin-left:1em;'>
4. Within each `supplysector` tag in the XML, make sure that the corresponding `input-subsidy` is added within each relevant `period` for each `stub-technology` you wish to constrain.
5. Save the XML and then point to it in your configuration file by adding the line: 
<p style='font-size:0.9em'>
`<Value name = "scen">../input/addons/malaysia/malaysia_elec_fuel_mix_2030_KL.xml</Value>`
6. To adjust the hydropower pathway, download the example XML file [malaysia_hydro_constraint_2030_KL.xml](https://github.com/JGCRI/seasia/blob/main/modeling/malaysia/malaysia_hydro_constraint_2030_KL.xml) to the folder. 
7. Within each `fixedOutput` tag in the XML, adjust the value to reflect desired hydropower output in each period. The user can also add additional periods. 
8. Save the XML and point to it in your configuration file by adding the line: 
<p style='font-size:0.9em'>
`<Value name = "scen">../input/addons/malaysia/malaysia_hydro_constraint_2030_KL.xml</Value>`

</p>
</p>

</span>
</div>

<br>

<!-------------------------->
<!-------------------------->
# Emissions Constraints
<!-------------------------->
<!-------------------------->

```{r emissions constraints files table, results = 'show', eval=TRUE, echo=FALSE, warning=FALSE, error = FALSE, message = FALSE}
library(kableExtra); library(dplyr)

# in the dt_url vector, add link(s) to the relevant XML file(s) used to run the policy. 
# also add the files to their corresponding directories in the repo.
dt_url <- c("https://github.com/JGCRI/seasia/blob/main/modeling/Malaysia/NetZeroC_Malaysia_2035_2050",
            "https://github.com/JGCRI/seasia/blob/main/modeling/Malaysia/Malaysia_LUC", "https://github.com/JGCRI/seasia/blob/main/modeling/Malaysia/NetZeroC_global_noMalaysia", "https://github.com/JGCRI/seasia/blob/main/modeling/Malaysia/ROW_LUC_noMalaysia")

# add scenario names, filenames, and descriptions of files to this table.
# make sure info in this table matches the links provided above (in the same order).
data.frame(
  Scenario = c("Net-Zero CO2 2050", "Net-Zero CO2 2050", "Net-Zero CO2 2050", "Net-Zero CO2 2050")) %>% 
  mutate("Files Used" = cell_spec( c("NetZeroC_thailand_2050",
                                     "Thailand_luc", "NetZeroC_ROW_2050", "ROW_luc"),
                                   "html", link = dt_url)) %>% 
  mutate(Description = c("CO2 emissions constraint for Malaysia (2035 - 2050)",
                         "GHG link file for Malaysia for land use change emissions", "CO2 emissions constraint rest of the World (2050)",
                         "GHG link file for land use change emissions for rest of the world")) %>%
  kable("html", escape = FALSE, col.names = c("Scenario", "Files Used", "Description")) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>%
  row_spec(0, background = "#2A2A2A", color = "white")
```

<!-------------------------->
<!----------Goal------------>
<!-------------------------->

<div class="warning" style='background-color:#E1F4F5; border-left: solid #1f1f1f 4px; border-radius: 4px; padding:0.7em;'>
<span>
<h3 style='text-align:center; font-size:24px'>
<b>Goal</b>
</h3>
<p style='margin-left:1em;'>
The aim of this example is to demonstrate how to apply an economy-wide emissions constraint for Malaysia in accord with its national goals:  net-zero  CO2 by 2050.
</p>
</span>
</div>

<br>


<!-------------------------->
<!--------Approach---------->
<!-------------------------->

<div class="warning" style='background-color:#fffae0; border-left: solid #1f1f1f 4px; border-radius: 4px; padding:0.7em;'>
<span>

<h3 style='text-align:center; font-size:24px'>
<b>Approach</b></h3>

<p style='margin-left:1em;'>
In GCAM, an emissions constraint can be accomplished by using a `ghgpolicy`, which is a special case of policy-portfolio-standard that applies to emissions.


</p>

</span>
</div>

<br>


<!--------------------------->
<!--------Background--------->
<!--------------------------->

<div class="warning" style='background-color:#EFFFC9; border-left: solid #1f1f1f 4px; border-radius: 4px; padding:0.7em;'>
<span>

<h3 style='text-align:center; font-size:24px'>
<b>Background</b></h3>

<p style='margin-left:1em;'>
To implement a `ghgpolicy` in GCAM, users specify the total amount of emissions (CO2 or GHG) in a time period. GCAM will then calculate the price on carbon needed to reach the constraint in each period.  GCAM finds the least-cost pathway in terms of technology deployment to satisfy the emissions constraint. An economy-wide constraint can be used by itself, or in combination with additional sectoral policies described above.  


There are some important considerations:  (1) What GHG's are included in the constraint (only CO2?)?, (2) What is the time period for the constraint (e.g., 2050, 2065)?, (3) What are the emissions in each period, (4) Will emissions decline linearly to zero or will another rate be specified?, (5) Will land use change emissions be included in the constraint?, and (5) What assumptions are made for emissions in the rest of the world?  This latter point is important when considering "carbon leakage," that is, how restrictions in emissions in one geography may lead to a shift in carbon-intensive activities to other locations. Below, we will describe how to implement a CO2 emissions constraint. See the [GCAM Policies](http://jgcri.github.io/gcam-doc/policies.html#emissions-policies) documentation for more information.
</p>
</span>
</div>

<br>

<!-------------------------->
<!---GCAM Implementation---->
<!-------------------------->

<div class="warning" style='background-color:#F5E5E1; border-left: solid #1f1f1f 4px; border-radius: 4px; padding:0.7em;'>
<span>
<h3 style='text-align:center; font-size:24px'>
<b>GCAM Implementation</b>
</h3>

<p style='margin-left:1em;'>
1. Create a folder in the input directory: `./gcam-core/input/addons`.
<!---include links to example XMLs here--->
2. Download the emissions constraint xml file(s) for Thailand [NetZeroC_Malaysia_2035_2050](https://github.com/JGCRI/seasia/blob/main/modeling/Malaysia/NetZeroC_Malaysia_2035_2050) and [Malaysia_LUC](https://github.com/JGCRI/seasia/blob/main/modeling/Malaysia/Malaysia_LUC)), as well as those for the rest of the world (ROW), [NetZeroC_global_noMalaysia_2050](https://github.com/JGCRI/seasia/blob/main/modeling/Malaysia/NetZeroC_global_noMalaysia_2050) and [ROW_LUC_noMalaysia](https://github.com/JGCRI/seasia/blob/main/modeling/Malaysia/ROW_LUC_noMalaysia).

3. The first file, NetZeroC_Malaysia_2035_2050, specifies emissions in units of tonnes of carbon (NOT CO2) in each period.    One way to determine the emissions constraint for each period is to examine the CO2 emissions in the reference case (See ModelInterface: "CO2 emissions by region").  Based on the reference emissions, one can create an emissions constraint accordingly, depending on the start date of the emissions constraint, end goal, and steepness of the decrease in emissions. 

4. You will notice that the constraint starts in 2035.  We want to first incorporate the pathway for Malaysia's      Nationally Determined Contribution (NDC) from 2020 to 2030.  Malaysia's NDC includes a target to reduce its          greenhouse gas (GHG) emissions intensity of GDP by 45% by 2030 relative to the emissions intensity of GDP in 2005. When we examine GHG emissions (See ModelInterface: "nonCO2 emissions by region") and GDP ((See ModelInterface: "GDP MER by region"), we see that this target is met without any additional policy in the reference scenario.  Thus, we only need to start our constraint in 2035.  We specify a linear decrease to 0 tonnes of C in 2050. 

5. We adopt a similar approach for the ROW, using the total emissions (tC) in 2020 for all countries as a starting point.  (We did not subtract our Malaysia's emissions, as they are quite small globally).  It is not absolutely necessary to adopt the very same emissions constraint for the ROW,  but the constraint should be strong enough to avoid carbon leakage from Malaysia' net-zero policy.

6. One needs to decide whether and how land use change emissions are incorporated into the constraint.  GCAM accounts for fossil fuel and industry CO2 emissions separately from land use change CO2 emissions. The Malaysia_luc.xml specifies how land use change CO2 emissions (LUC-CO2) in Malaysia are linked to the ghgpolicy ("CO2").  There are two parameters:  `price-adjust` and `demand-adjust`.  Price-adjust is used to convert prices for different GHG's.  A price-adjust of 1.0 for LUC-CO2 means the market price on LUC-CO2 emissions is the same as the price applied to fossil fuel and industry CO2 emissions.  A demand-adjust of 1 means that LUC-CO2 emissions are counted in the emissions constraint. These two parameters can be adjusted. In the sample files we have a price-adjust of 0, and a demand-adjust of 1. This can be modified depending on the goal and importance of LUC emissions. Note that Malaysia is removed from the ROW_LUC_noMalaysia.xml

7. Save the xml files and then point to them in your configuration file by adding the line: 
</p>
<p style='font-size:0.8em'>
<!---insert exmaple XML filenames--->
`<Value name = "scen">../input/addons/Malaysia/NetZeroC_Malaysia_2035_2050.xml</Value>`
`<Value name = "scen">../input/addons/Malaysia/Malaysia_luc.xml</Value>`
`<Value name = "scen">../input/addons/Malaysia/NetZeroC_global_noMalaysia_2050.xml</Value>`
`<Value name = "scen">../input/addons/Malaysia/ROW_LUC_noMalaysia.xml</Value>`
</p>
</p>

</span>
</div>

<br>

<br>

<!-------------------------->
<!-------------------------->
# Diagnostics
<!-------------------------->
<!-------------------------->
<p align="center"> <img src="images/divider.png"></p>

This section describes how to explore and compare the final output data using GCAM-specific post-processing tools.

## Extract GCAM Data
***

`gcamextractor` is an R package used to extract and process GCAM data and manipulate into standardized tables. `gcamextractor` converts GCAM outputs into commonly used units as well as aggregates across different classes and sectors for easy use in plots, maps and tables. For more information, please reference the documentation page found [here](https://jgcri.github.io/gcamextractor/index.html).

The first step is to create a path to the GCAM database, found in the output folder of your GCAM folder, and a list of desired parameters. The `readgcam()` function also requires region names and a specific output folder. Because reading in many parameters can take several minutes, we will be using existing outputs, found in your working directory's "gcamextractor" folder, generated by the code below.

```{r gcamextractor-setup, echo = TRUE, eval = FALSE}
sample_path <- "./output/database"

sample_params <- "summary"

regions <- c("Malaysia", "KualaLumpur", "Rest of Malaysia")

data <- gcamextractor::readgcam(gcamdatabase = sample_path,
                                paramsSelect = sample_params,
                                regionsSelect = regions,
                                regionsAggregate = list(regions),
                                regionsAggregateNames = "All of Malaysia",
                                folder = "..data/malaysia/gcamextractor")

```

```{r gcamextractor, echo = TRUE}
df1 <- read.csv("../data/malaysia/gcamextractor/gcamDataTable_aggClass1.csv")
df2 <- read.csv("../data/malaysia/gcamextractor/gcamDataTable_aggClass1.csv")

malaysia <- df1 %>%
  filter(region != ("Rest of Malaysia"),
         x > 2000)

```


## Plot Figures
***

`rchart` is a comprehensive charting package to plot and compare data across scenarios, regions, sectors and time periods in GCAM.

<br>

### Example 1: Socioeconomic summary
***

```{r rchart-socio, results = 'hide', eval = TRUE, echo = TRUE, warning = FALSE, error = FALSE, message = FALSE, fig.width = 16, fig.height = 8, out.width = "100%"}
socioeconomic_parameters <- c("pop", "gdp", "gdpPerCapita")
  
socioeconomic <- malaysia %>%
  filter(param %in% socioeconomic_parameters,
         region != "All of Malaysia") %>%
  mutate(param = units) %>% 
  rchart::chart(folder = "rchart/socioeconomic",
                chart_type = "region_absolute",
                save = F, 
                show = F,
                size_text = 19)

socioeconomic$chart_region_absolute
```

<br> 

### Example 2: Emissions by sector
***

``` {r rchart-emiss, results = 'hide', eval = TRUE, echo = TRUE, warning = FALSE, error = FALSE, message = FALSE}
co2 <- malaysia %>% filter(param == "emissCO2BySector",
                           region != "Malaysia") %>%
  mutate(value = value * 3.67,
         units = "CO2 Emissions (MTCO2eq)")

ghg <- malaysia %>% filter(param == "emissGHGBySectorGWPAR5",
                           region != "Malaysia")

malaysia_emissions <- bind_rows(co2, ghg)

```

``` {r rchart-emiss-plot, results = 'hide', eval = TRUE, echo = TRUE, warning = FALSE, error = FALSE, message = FALSE, fig.width = 12, fig.height = 9}
emissions <- malaysia_emissions %>%
  mutate(param = units) %>%
  rchart::chart(folder = "rchart/emissions_by_sector",
                chart_type = "class_absolute",
                save = F, 
                show = F,
                size_text = 18)

emissions$chart_class_byRegion
```

<br>

### Example 3: Emissions by gas
***

``` {r rchart-emiss-gas, results = 'hide', eval = TRUE, echo = TRUE, warning = FALSE, error = FALSE, message = FALSE}
co2_gas <- co2 %>%
  mutate(class = "CO2")

ghg_gas <- malaysia %>% 
  filter(param == "emissGHGByGasGWPAR5",
         class != "CO2",
         region != "Malaysia")

malaysia_emissions_gas <- bind_rows(co2_gas, ghg_gas)

```

``` {r rchart-emiss-gas-plot, results = 'hide', eval = TRUE, echo = TRUE, warning = FALSE, error = FALSE, message = FALSE}
gas <- malaysia_emissions_gas %>%
  mutate(param = units) %>%
  rchart::chart(folder = "rchart/emissions_by_gas",
                chart_type = "class_absolute",
                save = F, 
                show = F,
                size_text = 10)

gas$chart_class_byRegion

```

<br>

### Example 4: Final Energy by Fuel and Sector
***

```{r rchart-energy, results = 'hide', eval = TRUE, echo = TRUE, warning = FALSE, error = FALSE, message = FALSE, fig.width = 15, fig.height = 12}
energy_parameters <- c("energyFinalConsumBySecEJ", "energyFinalByFuelEJ")

energy <- malaysia %>% 
  filter(param %in% energy_parameters,
         region != "Malaysia") %>%
  mutate(param = units) %>%
  rchart::chart(folder = "rchart/energy",
                chart_type = "class_absolute",
                save = F, 
                show = F,
                size_text = 20)

energy$chart_class_byRegion
```

<br>

# {.unlisted .unnumbered}
```{r child = 'footer.rmd'}
```
